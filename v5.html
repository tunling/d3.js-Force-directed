<!DOCTYPE html>
<html>
  <head>
    <title>d3-force-V5</title>
    <script type="text/javascript" src="http://d3js.org/d3.v5.min.js">
	</script>
    <meta name="keywords" content="keyword1,keyword2,keyword3">
    <meta name="description" content="this is my page">
    <meta name="content-type" content="text/html; charset=GBK">
  </head> 
  <body>
	<p> 
		起点 <input type="text" value="" id = "node1"> 终点 <input type="text" value="" id = "node2">
		关系 <input type="text" value="" id = "relation"> 权重 <input type="text" value="" id = "weight">
		<button id="b1">连接节点</button>
		<button id="b2">删除连线</button>
	</p>
	<p>
		节点<input type="text" value="" id = "node3">
		<button id="b3">删除节点</button>
		<button id="b4">添加节点</button>
		<button id="b5">播放/暂停</button>
		<button id="b6">前进</button>
	</p>
    <script>
    	var marge = {top:10,bottom:10,left:10,right:10};
    	var svg, g;
    	var width, height;
    	//数据
    	var nodes = [
    		{name:"湖南邵阳"},
    		{name:"山东莱州"},
    		{name:"广东阳江"},
    		{name:"山东枣庄"},
    		{name:"泽"},
    		{name:"恒"},
    		{name:"鑫"},
    		{name:"明山"},
    		{name:"班长"}
    	];
    	var edges = [
    		{source:0,target:4,relation:"籍贯",value:1.3},
    		{source:4,target:5,relation:"舍友",value:1},
    		{source:4,target:6,relation:"舍友",value:1},
    		{source:4,target:7,relation:"舍友",value:1},
    		{source:1,target:6,relation:"籍贯",value:2},
    		{source:2,target:5,relation:"籍贯",value:0.9},
    		{source:3,target:7,relation:"籍贯",value:1},
    		{source:5,target:6,relation:"同学",value:1.6},
    		{source:6,target:7,relation:"朋友",value:0.7},
    		{source:6,target:8,relation:"职责",value:2}
    	];
    	//颜色比例尺 初始化力导向图 边 边文字 节点组（节点+节点文字）
    	var colorScale, forceSimulation, links, linksText, gs;
		render();
		//连接节点
		d3.select(document.getElementById("b1")).on("click", function() {
			var node1=document.getElementById("node1").value;
			var node2=document.getElementById("node2").value;
			var relations=document.getElementById("relation").value;
			var weight=parseInt(document.getElementById("weight").value);
			var s=getNodeIndex(node1);
			var t=getNodeIndex(node2);
			if(s!=-1&&t!=-1&&relations!=""&&weight>0){
				var found=0;
				for(var i=0;i<edges.length;i++){
					if(edges[i].source.name==node1&&edges[i].target.name==node2
					||edges[i].target.name==node1&&edges[i].source.name==node2){
						found=1;
					}
				}
				if(found==0){
					edges.push({source:s, target:t,relation:relations,value:weight});
					render();
				}
			}
			console.log(edges);
		});
		//删除连线
		d3.select(document.getElementById("b2")).on("click", function() {
			var node1=document.getElementById("node1").value;
			var node2=document.getElementById("node2").value;
			if(getNodeIndex(node1)!=-1&&getNodeIndex(node2)!=-1){
				var found=0;
				for(var i=0;i<edges.length;i++){
					if(edges[i].source.name==node1&&edges[i].target.name==node2
					||edges[i].target.name==node1&&edges[i].source.name==node2){
						found=1;
						edges.splice(i,1);
					}
				}
				svg.selectAll("line").each(function(d){
					if(d.source.name==node1&&d.target.name==node2
					||d.target.name==node1&&d.source.name==node2){
						d3.select(d).remove();
					}
				});
				if(found==1){
					render();
				}
        	}
			console.log(edges);
		});
		//删除节点
		var new_name=1;
		d3.select(document.getElementById("b3")).on("click", function() {
			var node3=document.getElementById("node3").value;
			var node3Index=getNodeIndex(node3);
			if(node3Index!=-1){
				nodes.splice(node3Index,1);
				var len=edges.length;
				for(var i=0;i<len;i++){
					if(edges[i].source.name==node3|| edges[i].target.name==node3){
						edges.splice(i,1);
						i--;
						len--;
					}
				}
				render();
			}
		});
		//添加节点
		d3.select(document.getElementById("b4")).on("click", function() {
			var node3=document.getElementById("node3").value;
			if(node3!=""){
				nodes.push({name:node3});
				render();
			}
			
		});
		//播放暂停
		var stopping=0;
		d3.select(document.getElementById("b5")).on("click", function() {
			if(stopping==0){
				forceSimulation.stop();
				stopping=1;
			}else{
				forceSimulation.restart();
				stopping=0;
			}
			
		});
		//前进
		d3.select(document.getElementById("b6")).on("click", function() {
			edges = [
				{source:0,target:4,relation:"籍贯",value:1.3},
				{source:4,target:5,relation:"舍友",value:1},
				{source:4,target:6,relation:"舍友",value:1},
				{source:1,target:6,relation:"籍贯",value:2},
				{source:2,target:5,relation:"籍贯",value:0.9},
				{source:3,target:7,relation:"籍贯",value:1},
				{source:5,target:6,relation:"同学",value:1.6},
				{source:6,target:8,relation:"职责",value:2}
    		];
			render();
		});
		//绘制函数
		function render(){
			d3.selectAll("svg").remove();
			width = 960;
			height = 560;
			svg = d3.select("body")
            		.append("svg")
					.attr("width",width)
            		.attr("height",height);
			g = svg.append("g")
    			.attr("transform","translate("+marge.top+","+marge.left+")");
			colorScale = d3.scaleOrdinal()
						.domain(d3.range(nodes.length))
						.range(d3.schemeCategory10);
			forceSimulation = d3.forceSimulation()
						.velocityDecay([0.2])
						.force("link",d3.forceLink())
						.force("charge",d3.forceManyBody().strength(-700).distanceMax(250))
						.force("center",d3.forceCenter().x(width/2).y(height/2))
						.nodes(nodes)
    					.on("tick",ticked);
			//边长度
			forceSimulation.force("link")
						.links(edges)
						.distance(function(d){
							return d.value*30;
						});	
			//绘制边
			links=g.append("g").selectAll("line").data(edges)
    		.enter()
    		.append("line")
    		.attr("stroke",function(d,i){
    			return colorScale(i);
    		})
    		.attr("stroke-width",2);
			linksText=g.append("g").selectAll("text").data(edges)
				.enter()
				.append("text")
				.text(function(d){
					return d.relation;
				});
			//绘制节点组
			gs=g.selectAll(".circleText").data(nodes)
				.enter()
				.append("g")
				.attr("transform",function(d,i){
					var cirX = d.x;
					var cirY = d.y;
					return "translate("+cirX+","+cirY+")";
				})
				.call(d3.drag()
					.on("start",started)
					.on("drag",dragged)
					.on("end",ended)
				);	
			//绘制节点
			gs.append("circle")
				.attr("r",10)
				.attr("fill",function(d,i){
					return colorScale(i);
				})
			//绘制节点文字
			gs.append("text")
				.attr("x",-10)
				.attr("y",-20)
				.attr("dy",10)
				.text(function(d){
					return d.name;
				});
			//tick函数
			function ticked(){
				links.attr("x1",function(d){return d.source.x;})
					.attr("y1",function(d){return d.source.y;})
					.attr("x2",function(d){return d.target.x;})
					.attr("y2",function(d){return d.target.y;});	
				linksText.attr("x",function(d){
						return (d.source.x+d.target.x)/2;
					})
					.attr("y",function(d){
						return (d.source.y+d.target.y)/2;
					});		
				gs.attr("transform",function(d) { return "translate(" + d.x + "," + d.y + ")"; });
    		}
			function started(d){
				if(!d3.event.active){
					forceSimulation.alphaTarget(0.4).restart();
				}
				d.fx = d.x;
				d.fy = d.y;
			}
			function dragged(d){
				d.fx = d3.event.x;
				d.fy = d3.event.y;
			}
			function ended(d){
				if(!d3.event.active){
					forceSimulation.alphaTarget(0);
				}
				d.fx = null;
				d.fy = null;
			}
		}
		//根据名称获取节点索引
		function getNodeIndex(name){
			for(var i=0;i<nodes.length;i++){
				if(nodes[i].name==name){
					return i;
				}
			}
			return -1;
		}
    </script>
  </body>
</html>
